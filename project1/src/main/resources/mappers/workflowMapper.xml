<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.project.mapper.WorkflowMapper">
	
	<!-- 워크플로우 상세 -->
	<select id="getWorkflow" parameterType="String" resultType="WorkflowVO">
		select * from workflow
		 where wf_code=#{wf_code}
	</select>
	
	<!-- 보낸 워크플로우 목록 -->
	<select id="getSentWorkflowList" parameterType="WorkflowVO" resultType="WorkflowVO">
		select * from workflow
		 where wf_sender=#{wf_sender} and wf_status=#{wf_status}
	</select>
	
	<!-- 보낸 워크플로우 목록 중 알람이 필요한 것들 -->
	<select id="getRecentSentWorkflowList" parameterType="WorkflowVO" resultType="WorkflowVO">
		select * from workflow
		 where wf_sender=#{wf_sender} and wf_status=#{wf_status} and wf_Alarm_token='1'
	</select>
	
	<!-- 받은 워크플로우 목록 -->
	<select id="getReceivedWorkflowList" parameterType="WorkflowVO" resultType="WorkflowVO">
		select * from workflow
		 where wf_receiver=#{wf_receiver} and wf_status=#{wf_status}
	</select>
	
	<!-- 워크플로우 응답 -->
	<update id="responseWorkflow" parameterType="WorkflowVO">
		update workflow
		 set 
				<choose>
		            <when test="wf_progress='1'">
		            	<choose>
		            		<when test="wf_receiver_2nd != null">
		            			<choose>
		            				<when test="wf_result = '1'">
		            					wf_progress='2'
					         		     ,wf_result_1st=#{wf_result}
					          		     ,wf_comment_1st=#{wf_comment} 
					         		     ,wf_result_date_1st=now()
										 ,wf_receiver=#{wf_receiver_2nd}
		            				</when>
		            				<when test="wf_result = '0'">
		            					wf_progress='0'
				            			 ,wf_result=#{wf_result} 
							             ,wf_result_1st=#{wf_result}
							             ,wf_comment_1st=#{wf_comment} 
				               			 ,wf_result_date=now() 
							             ,wf_result_date_1st=now()
				                		 ,wf_status='0' 
		            				</when>
		            				<when test="wf_result = '2'">
					         		     wf_result_1st=#{wf_result}
					          		     ,wf_comment_1st=#{wf_comment} 
					         		     ,wf_result_date_1st=now()
		            				</when>
		            				<otherwise>
		           					</otherwise>
		            			</choose>
		            		</when>
		            		<when test="wf_receiver_2nd == null">
		                		 <choose>
		                		 	<when test="wf_result = '1' or wf_result = '0'">
									    wf_progress='0'
				            			 ,wf_result=#{wf_result} 
							             ,wf_result_1st=#{wf_result}
							             ,wf_comment_1st=#{wf_comment} 
				               			 ,wf_result_date=now() 
							             ,wf_result_date_1st=now()
				                		 ,wf_status='0' 
									</when>
		            				<when test="wf_result = '2'">
					         		     wf_result_1st=#{wf_result}
					          		     ,wf_comment_1st=#{wf_comment} 
					         		     ,wf_result_date_1st=now()
		            				</when>
		            				<otherwise>
		           					</otherwise>
		            			</choose>
		            		</when>
		            		<otherwise>
		           			</otherwise>
		            	</choose>
		            </when>
		            
		            <when test="wf_progress='2'">
		            	<choose>
		            		<when test="wf_receiver_3nd != null">
		            			<choose>
		            				<when test="wf_result = '1'">
		            					wf_progress='3'
					         		     ,wf_result_2nd=#{wf_result}
					          		     ,wf_comment_2nd=#{wf_comment} 
					         		     ,wf_result_date_2nd=now()
										 ,wf_receiver=#{wf_receiver_3rd}
		            				</when>
		            				<when test="wf_result = '0'">
		            					wf_progress='0'
				            			 ,wf_result=#{wf_result} 
							             ,wf_result_2nd=#{wf_result}
							             ,wf_comment_2nd=#{wf_comment} 
				               			 ,wf_result_date=now() 
							             ,wf_result_date_2nd=now()
				                		 ,wf_status='0' 
		            				</when>
		            				<when test="wf_result = '2'">
					         		     wf_result_2nd=#{wf_result}
					          		     ,wf_comment_2nd=#{wf_comment} 
					         		     ,wf_result_date_2nd=now()
		            				</when>
		            				<otherwise>
		           					</otherwise>
		            			</choose>
		            		</when>
		            		<when test="wf_receiver_3nd == null">
		            			<choose>
		                		 	<when test="wf_result = '1' or wf_result = '0'">
									    wf_progress='0'
				            			 ,wf_result=#{wf_result} 
							             ,wf_result_2nd=#{wf_result}
							             ,wf_comment_2nd=#{wf_comment} 
				               			 ,wf_result_date=now() 
							             ,wf_result_date_2nd=now()
				                		 ,wf_status='0' 
									</when>
		            				<when test="wf_result = '2'">
					         		     wf_result_2nd=#{wf_result}
					          		     ,wf_comment_2nd=#{wf_comment} 
					         		     ,wf_result_date_2nd=now()
		            				</when>
		            				<otherwise>
		           					</otherwise>
		            			</choose>
		            		</when>
		            		<otherwise>
		           			</otherwise>
		            	</choose>
		            </when>
		            
		            <when test="wf_progress='3'">
		                <choose>
                		 	<when test="wf_result = '1' or wf_result = '0'">
							    wf_progress='0'
		            			 ,wf_result=#{wf_result} 
					             ,wf_result_3rd=#{wf_result}
					             ,wf_comment_3rd=#{wf_comment} 
		               			 ,wf_result_date=now() 
					             ,wf_result_date_3rd=now()
		                		 ,wf_status='0' 
							</when>
            				<when test="wf_result = '2'">
			         		     wf_result_3rd=#{wf_result}
			          		     ,wf_comment_3rd=#{wf_comment} 
			         		     ,wf_result_date_3rd=now()
            				</when>
            				<otherwise>
           					</otherwise>
            			</choose>
		            </when>

		            <otherwise>
		            </otherwise>

		        </choose>
		        
		  where wf_code=#{wf_code}
	</update>
	
	<!-- 받은 워크플로우 알람 -->
	<select id="getWorkflowAlarmList" parameterType="String" resultType="com.project.domain.WorkflowAlarmVO">
		select wf.wf_code as wf_code, wf.wf_type as wf_type, wf.wf_title as wf_title, wf.wf_progress as wf_progress , wf.wf_sender as wf_sender,  
	        case 
	            when wf.wf_progress = '1' then wf.wf_create_date
	            when wf.wf_progress = '2' then wf.wf_result_date_1st
	            when wf.wf_progress = '3' then wf.wf_result_date_2nd
	            else null
	        end as wf_date,
	        emp.emp_name as emp_name, 
	        emp.emp_bnum as emp_bnum, 
	        emp.emp_dnum as emp_dnum, 
	        emp.emp_position as emp_position
	    from workflow wf join employee emp on wf.wf_sender = emp.emp_id
	    where wf.wf_receiver = #{emp_id} and wf.wf_status = '1' and wf.wf_alarm_token = '1'
	</select>
	
	<update id="WorkflowAlarmCheck" parameterType="String">
		update workflow set wf_alarm_token = '0' where wf_code=#{wf_code}
	</update>
	
</mapper>