<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.project.mapper.MessageMapper">

	<select id="findRoom" resultType="int" parameterType="MessageVO">
	    SELECT room_id
	     FROM msg_room_participant
	     WHERE room_id IN ( 
         					SELECT room_id 
        					FROM msg_room_participant 
        					WHERE receiver = #{sender.emp_id} OR receiver = #{receiver.emp_id} 
        					GROUP BY room_id 
        					HAVING COUNT(DISTINCT receiver) = 2 
	    					) 
	     LIMIT 1  <!-- 방이 여러 개가 있을 수 있으므로 하나만 선택 -->
	</select>
	
	<insert id="createRoom" parameterType="MessageVO">
	INSERT INTO msg_room (room_name)
     VALUES (CONCAT(#{sender.emp_name}, ', ', #{receiver.emp_name})
    </insert>
     
    <select id="selectLastRoomId" resultType="int">
	SELECT LAST_INSERT_ID()
	</select>
	
	<insert id="insertRoom_participant" parameterType="MessageVO">
	INSERT INTO msg_room_participant (room_id, receiver)
            VALUES (#{room_id}, #{receiver.emp_id})
	</insert>	
	
	<insert id="sendMessage" parameterType="MessageVO">
	INSERT INTO messages (room_id, sender, msg_content) 
	 VALUES (#{room_id}, #{sender.emp_id}, #{msg_content})
	</insert>
	
	<select id="getMessages" parameterType="MessageVO" resultType="MessageVO">
	    select m.*,r.room_name, rp.role
	     from messages m
	     join msg_room r on m.room_id = r.room_id
	     join msg_room_participant rp on r.room_id = rp.room_id
	     where r.room_id = #{room_id} 
	     and m.msg_date > rp.join_date;
	</select>
	
</mapper>  
  